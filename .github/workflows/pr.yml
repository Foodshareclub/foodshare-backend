name: PR Validation

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ── Change detection ──────────────────────────────────────────────────
  detect-changes:
    name: Detect changes
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      functions-changed: ${{ steps.changes.outputs.functions-changed }}
      functions-list: ${{ steps.changes.outputs.functions-list }}
      shared-changed: ${{ steps.changes.outputs.shared-changed }}
      migrations-changed: ${{ steps.changes.outputs.migrations-changed }}
      migrations-list: ${{ steps.changes.outputs.migrations-list }}
      infrastructure-changed: ${{ steps.changes.outputs.infrastructure-changed }}
      config-changed: ${{ steps.changes.outputs.config-changed }}
      any-deployable: ${{ steps.changes.outputs.any-deployable }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - id: changes
        uses: ./.github/actions/detect-changes

  # ── Lint ──────────────────────────────────────────────────────────────
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: detect-changes
    timeout-minutes: 3
    defaults:
      run:
        working-directory: supabase/functions
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: ./.github/actions/setup-deno

      - name: deno lint
        run: deno lint

      - name: deno fmt --check
        run: deno fmt --check

      - name: Check for problematic JSR imports
        run: |
          if grep -r "jsr:@supabase/functions-js" .; then
            echo "::error::Problematic JSR import detected! This import causes cold start timeouts."
            echo "::error::Remove: import \"jsr:@supabase/functions-js/edge-runtime.d.ts\";"
            exit 1
          fi
          echo "No problematic JSR imports found."

  # ── Type-check ───────────────────────────────────────────────────────
  typecheck:
    name: Type-check
    runs-on: ubuntu-latest
    needs: detect-changes
    timeout-minutes: 5
    continue-on-error: true
    defaults:
      run:
        working-directory: supabase/functions
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: ./.github/actions/setup-deno

      - name: deno check
        id: check
        run: |
          set +e
          OUTPUT=$(deno check '**/*.ts' 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"

          ERROR_COUNT=$(echo "$OUTPUT" | grep -c "^error\[" || echo "0")
          echo "error-count=$ERROR_COUNT" >> "$GITHUB_OUTPUT"
          echo "exit-code=$EXIT_CODE" >> "$GITHUB_OUTPUT"

          BASELINE=324
          DELTA=$((ERROR_COUNT - BASELINE))
          echo "baseline=$BASELINE" >> "$GITHUB_OUTPUT"
          echo "delta=$DELTA" >> "$GITHUB_OUTPUT"

          {
            echo "## Type-check"
            echo ""
            if [ "$DELTA" -gt 0 ]; then
              echo "> **Warning**: TS errors increased by +$DELTA (now $ERROR_COUNT, baseline $BASELINE)"
            elif [ "$DELTA" -lt 0 ]; then
              echo "> TS errors decreased by $DELTA (now $ERROR_COUNT, baseline $BASELINE)"
            else
              echo "> TS errors unchanged: $ERROR_COUNT (baseline $BASELINE)"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

          exit $EXIT_CODE

  # ── Test ─────────────────────────────────────────────────────────────
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: detect-changes
    timeout-minutes: 5
    defaults:
      run:
        working-directory: supabase/functions
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: ./.github/actions/setup-deno

      - name: deno test
        id: test
        run: |
          set +e
          OUTPUT=$(deno test --allow-all 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"

          PASS=$(echo "$OUTPUT" | grep -oP '\d+ passed' | grep -oP '\d+' || echo "0")
          FAIL=$(echo "$OUTPUT" | grep -oP '\d+ failed' | grep -oP '\d+' || echo "0")

          {
            echo "## Tests"
            echo ""
            echo "| Passed | Failed |"
            echo "|--------|--------|"
            echo "| $PASS | $FAIL |"
          } >> "$GITHUB_STEP_SUMMARY"

          exit $EXIT_CODE

  # ── Security ─────────────────────────────────────────────────────────
  security:
    name: Security scan
    runs-on: ubuntu-latest
    needs: detect-changes
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Scan for leaked secrets
        uses: trufflesecurity/trufflehog@7635b24fd512a2e817dd3e9dd661caaf035a079d # v3.93.1
        with:
          extra_args: --only-verified --results=verified

  # ── Validate migrations (conditional) ────────────────────────────────
  validate-migrations:
    name: Validate migrations
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.migrations-changed == 'true'
    timeout-minutes: 5

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: supabase_admin
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U supabase_admin"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq postgresql-client

      - name: Create schema_migrations table
        run: |
          psql -h localhost -U supabase_admin -d postgres -c "
            CREATE SCHEMA IF NOT EXISTS supabase_migrations;
            CREATE TABLE IF NOT EXISTS supabase_migrations.schema_migrations (
              version text PRIMARY KEY,
              statements text,
              name text
            );
          "
        env:
          PGPASSWORD: postgres

      - name: Apply baseline (best-effort)
        run: |
          echo "Applying baseline migration (best-effort — warnings expected)..."
          psql -h localhost -U supabase_admin -d postgres \
            -f supabase/migrations/20260128195318_baseline.sql \
            2>&1 || true
          echo "Baseline applied (errors from \\restrict, pg_cron, pg_net are expected)"
        env:
          PGPASSWORD: postgres

      - name: Apply incremental migrations (strict)
        run: |
          FAILED=0
          for f in supabase/migrations/*.sql; do
            [ -f "$f" ] || continue
            BASENAME=$(basename "$f")

            if [ "$BASENAME" = "20260128195318_baseline.sql" ]; then
              continue
            fi

            if grep -qE '(cron\.(schedule|unschedule)|net\.http_(post|get))' "$f"; then
              echo "--- Skipping: $BASENAME (requires pg_cron/pg_net) ---"
              continue
            fi

            if grep -qE '(ALTER TABLE|CREATE INDEX|COMMENT ON|INSERT INTO|FROM)\s+(public\.)?(posts|profiles|community_fridges|blocked_users)|extensions\.(st_|geometry)|auth\.(uid|jwt|users)' "$f"; then
              echo "--- Skipping: $BASENAME (depends on baseline tables/extensions) ---"
              continue
            fi

            VERSION=$(echo "$BASENAME" | grep -oE '^[0-9]+')
            echo "--- Applying: $BASENAME ---"

            if ! psql -h localhost -U supabase_admin -d postgres \
              -v ON_ERROR_STOP=1 -f "$f"; then
              echo "::error::Migration failed: $BASENAME"
              FAILED=1
              break
            fi

            psql -h localhost -U supabase_admin -d postgres -c \
              "INSERT INTO supabase_migrations.schema_migrations (version) VALUES ('$VERSION') ON CONFLICT DO NOTHING;"
          done

          if [ "$FAILED" -ne 0 ]; then
            echo "::error::Migration validation failed — deploy blocked"
            exit 1
          fi
          echo "All incremental migrations applied successfully."
        env:
          PGPASSWORD: postgres

      - name: Scan for dangerous patterns
        run: |
          WARNINGS=0
          {
            echo "## Migration Safety Scan"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          for f in supabase/migrations/*.sql; do
            [ -f "$f" ] || continue
            BASENAME=$(basename "$f")

            ISSUES=""
            if grep -qiE 'DROP\s+TABLE' "$f"; then
              ISSUES="$ISSUES DROP TABLE;"
            fi
            if grep -qiE 'DROP\s+COLUMN' "$f"; then
              ISSUES="$ISSUES DROP COLUMN;"
            fi
            if grep -qiE 'TRUNCATE' "$f"; then
              ISSUES="$ISSUES TRUNCATE;"
            fi
            if grep -qiE 'CREATE\s+INDEX' "$f" && ! grep -qiE 'CONCURRENTLY' "$f"; then
              ISSUES="$ISSUES INDEX without CONCURRENTLY;"
            fi
            if grep -qiE 'DROP\s+(TABLE|INDEX|VIEW)' "$f" && ! grep -qiE 'IF\s+EXISTS' "$f"; then
              ISSUES="$ISSUES DROP without IF EXISTS;"
            fi

            if [ -n "$ISSUES" ]; then
              WARNINGS=$((WARNINGS + 1))
              echo "::warning file=$f::Dangerous pattern detected:$ISSUES"
              echo "- **$BASENAME**: $ISSUES" >> "$GITHUB_STEP_SUMMARY"
            fi
          done

          if [ "$WARNINGS" -eq 0 ]; then
            echo "No dangerous patterns found." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Migration diff summary
        if: always()
        run: |
          {
            echo ""
            echo "<details>"
            echo "<summary>Migration SQL diffs</summary>"
            echo ""
            echo '```sql'
            for f in supabase/migrations/*.sql; do
              [ -f "$f" ] || continue
              BASENAME=$(basename "$f")
              if [ "$BASENAME" = "20260128195318_baseline.sql" ]; then
                continue
              fi
              echo "-- $BASENAME"
              head -50 "$f"
              echo ""
            done
            echo '```'
            echo "</details>"
          } >> "$GITHUB_STEP_SUMMARY"

  # ── Validate functions (conditional) ─────────────────────────────────
  validate-functions:
    name: Validate functions
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.functions-changed == 'true' || needs.detect-changes.outputs.shared-changed == 'true'
    timeout-minutes: 5
    defaults:
      run:
        working-directory: supabase/functions
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: ./.github/actions/setup-deno

      - name: Validate changed functions
        env:
          FUNCTIONS_LIST: ${{ needs.detect-changes.outputs.functions-list }}
          SHARED: ${{ needs.detect-changes.outputs.shared-changed }}
        run: |
          # If shared changed, validate all function dirs
          if [ "$SHARED" = "true" ]; then
            DIRS=$(find . -maxdepth 1 -type d \( -name 'api-v1-*' -o -name 'telegram-*' -o -name 'whatsapp-*' -o -name 'main' \) | sed 's|^\./||' | sort)
          else
            DIRS=$(echo "$FUNCTIONS_LIST" | jq -r '.[]' 2>/dev/null || echo "")
          fi

          if [ -z "$DIRS" ]; then
            echo "No function directories to validate"
            exit 0
          fi

          {
            echo "## Function Validation"
            echo ""
            echo "| Function | Type-check | Size | Deno.serve | No JSR | No cross-import |"
            echo "|----------|-----------|------|------------|--------|-----------------|"
          } >> "$GITHUB_STEP_SUMMARY"

          FAIL=0

          for DIR in $DIRS; do
            [ -d "$DIR" ] || continue
            [ -f "$DIR/index.ts" ] || continue

            TC_OK="pass"
            SIZE_OK="pass"
            SERVE_OK="pass"
            JSR_OK="pass"
            IMPORT_OK="pass"

            # 1. Type-check
            if ! deno check "$DIR/index.ts" 2>/dev/null; then
              TC_OK="warn"
            fi

            # 2. Bundle size via deno info
            SIZE_OUTPUT=$(deno info --json "$DIR/index.ts" 2>/dev/null || echo "{}")
            TOTAL_SIZE=$(echo "$SIZE_OUTPUT" | jq -r '.totalSize // 0' 2>/dev/null || echo "0")
            SIZE_MB=$((TOTAL_SIZE / 1048576))
            if [ "$SIZE_MB" -gt 5 ]; then
              SIZE_OK="FAIL (${SIZE_MB}MB)"
              FAIL=1
            else
              SIZE_OK="${SIZE_MB}MB"
            fi

            # 3. Deno.serve pattern
            if ! grep -q 'Deno\.serve(' "$DIR/index.ts"; then
              SERVE_OK="FAIL"
              FAIL=1
            fi

            # 4. No JSR imports
            if grep -rq 'jsr:@supabase/functions-js' "$DIR/"; then
              JSR_OK="FAIL"
              FAIL=1
            fi

            # 5. No cross-function imports (only _shared/ allowed)
            if grep -rE "from ['\"]\.\./(api-v1-|telegram-|whatsapp-|main/)" "$DIR/" 2>/dev/null; then
              IMPORT_OK="FAIL"
              FAIL=1
            fi

            echo "| $DIR | $TC_OK | $SIZE_OK | $SERVE_OK | $JSR_OK | $IMPORT_OK |" >> "$GITHUB_STEP_SUMMARY"
          done

          if [ "$FAIL" -ne 0 ]; then
            echo "::error::Function validation failed — see summary"
            exit 1
          fi

  # ── PR Summary (required status check) ──────────────────────────────
  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, lint, typecheck, test, security, validate-migrations, validate-functions]
    if: always()
    timeout-minutes: 2
    steps:
      - name: Aggregate results
        env:
          LINT_RESULT: ${{ needs.lint.result }}
          TYPECHECK_RESULT: ${{ needs.typecheck.result }}
          TEST_RESULT: ${{ needs.test.result }}
          SECURITY_RESULT: ${{ needs.security.result }}
          MIGRATIONS_RESULT: ${{ needs.validate-migrations.result }}
          FUNCTIONS_RESULT: ${{ needs.validate-functions.result }}
        run: |
          {
            echo "## PR Validation Summary"
            echo ""
            echo "| Job | Status |"
            echo "|-----|--------|"
            echo "| Lint | ${LINT_RESULT} |"
            echo "| Type-check | ${TYPECHECK_RESULT} |"
            echo "| Test | ${TEST_RESULT} |"
            echo "| Security | ${SECURITY_RESULT} |"
            echo "| Migrations | ${MIGRATIONS_RESULT:-skipped} |"
            echo "| Functions | ${FUNCTIONS_RESULT:-skipped} |"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Gate
        env:
          LINT_RESULT: ${{ needs.lint.result }}
          TEST_RESULT: ${{ needs.test.result }}
          SECURITY_RESULT: ${{ needs.security.result }}
          MIGRATIONS_RESULT: ${{ needs.validate-migrations.result }}
          FUNCTIONS_RESULT: ${{ needs.validate-functions.result }}
        run: |
          # Fail if any required job failed (typecheck is continue-on-error so we allow failure)
          if [ "$LINT_RESULT" = "failure" ]; then
            echo "::error::Lint failed"
            exit 1
          fi
          if [ "$TEST_RESULT" = "failure" ]; then
            echo "::error::Tests failed"
            exit 1
          fi
          if [ "$SECURITY_RESULT" = "failure" ]; then
            echo "::error::Security scan failed"
            exit 1
          fi
          if [ "$MIGRATIONS_RESULT" = "failure" ]; then
            echo "::error::Migration validation failed"
            exit 1
          fi
          if [ "$FUNCTIONS_RESULT" = "failure" ]; then
            echo "::error::Function validation failed"
            exit 1
          fi
          echo "All checks passed"
