# Supabase Edge Functions Configuration
# See: https://supabase.com/docs/guides/functions/function-configuration

# =============================================================================
# Core Functions
# =============================================================================

[functions.api-v1-cache]
verify_jwt = false

# Unified Localization API (replaces locale + localization)
# UI strings, content translation, locale sync, backfills
[functions.api-v1-localization]
verify_jwt = false

[functions.api-v1-images]
verify_jwt = false

# Unified Health API (consolidates health + health-advanced)
# Public monitoring endpoint — no auth required
[functions.api-v1-health]
verify_jwt = false

# Unified Search & Indexing API v2
# - GET ?q=...&mode=hybrid — search
# - GET ?route=health|stats — monitoring
# - POST ?route=index — webhook indexing (HMAC verified)
# - POST ?route=batch — admin batch indexing (API key auth)
[functions.api-v1-search]
verify_jwt = false

# Feature Flags, A/B experiments, version compatibility (replaces feature-flags)
# Auth optional — flags work for anonymous users
[functions.api-v1-feature-flags]
verify_jwt = false

# Unified AI API (replaces ai-api + hf-inference)
# Chat (Groq), embeddings (z.ai), inference (HF) — auth per-route
[functions.api-v1-ai]
verify_jwt = false

[functions.api-v1-auth]
verify_jwt = false

# =============================================================================
# Core API Endpoints (auth handled internally by createAPIHandler)
# =============================================================================

[functions.api-v1-chat]
verify_jwt = false

[functions.api-v1-engagement]
verify_jwt = false

[functions.api-v1-metrics]
verify_jwt = false

[functions.api-v1-products]
verify_jwt = false

[functions.api-v1-profile]
verify_jwt = false

[functions.api-v1-reviews]
verify_jwt = false

[functions.api-v1-sync]
verify_jwt = false

# =============================================================================
# Bot Webhooks
# =============================================================================

[functions.telegram-bot-foodshare]
verify_jwt = false

[functions.whatsapp-bot-foodshare]
verify_jwt = false

# =============================================================================
# Subscription/Payment
# =============================================================================

# subscription-webhook merged into api-v1-subscription/webhook

# =============================================================================
# UNIFIED SUBSCRIPTION API v1
# =============================================================================
# Consolidates sync-subscription + subscription-cron + subscription-webhook:
# - GET / - Check subscription status (JWT auth)
# - POST /sync - Sync subscription after purchase (JWT auth)
# - POST /cron - Run cron tasks: DLQ, metrics, cleanup (cron auth)
# - GET /health - Health check
[functions.api-v1-subscription]
verify_jwt = false

# =============================================================================
# UNIFIED NOTIFICATION API v1 (MASTER)
# =============================================================================
# Enterprise-grade unified notification API consolidating ALL notifications:
#
# Channels:
# - Email (Resend/Brevo/SES/MailerSend), Push (FCM/APNs/WebPush), SMS, In-App
#
# Routes:
# - POST /send, /send/batch, /send/template
# - POST /digest/process (cron)
# - GET/PUT /preferences, POST/DELETE /preferences/dnd
# - POST /webhook/:provider (delivery events)
# - GET /health, /stats, /dashboard
# - POST /trigger/new-post (db webhook - replaces notify-new-post)
# - POST /trigger/new-user (db webhook - replaces notify-new-user)
# - POST /trigger/forum-post (db webhook - replaces notify-forum-post)
# - POST /trigger/new-report (db webhook - replaces notify-new-report)
# - POST /trigger/new-listing (authenticated - replaces notify-new-listing)
# Auth handled internally per-route

[functions.api-v1-notifications]
verify_jwt = false

# Unified Email API (queue processing + direct send + templates + provider health)
[functions.api-v1-email]
verify_jwt = false

# =============================================================================
# UNIFIED ADMIN API v1
# =============================================================================
# Consolidates all admin operations:
# - /users - List, roles, ban/unban
# - /listings - CRUD, activate/deactivate, bulk operations
# - /health - Health check
[functions.api-v1-admin]
verify_jwt = false

# =============================================================================
# UNIFIED VALIDATION API v1
# =============================================================================
# Consolidates all validation operations (replaces validate-listing, validate-profile, validate-review):
# - POST /listing - Validate listing
# - POST /profile - Validate profile
# - POST /review - Validate review
# - POST /email - Validate email format
# - POST /password - Validate password with strength
# - POST /batch - Batch validate multiple entities
# - GET /rules - Get validation constants for client sync
# - GET /health - Health check
[functions.api-v1-validation]
verify_jwt = false

# =============================================================================
# UNIFIED GEOCODING API v1
# =============================================================================
# Consolidates all geocoding + map operations (replaces update-coordinates, update-post-coordinates, geolocate-user, map-services):
# - POST /address - Geocode and update user address
# - POST /post - Geocode single post
# - POST /post/batch - Batch process posts from queue
# - GET /post/stats - Queue statistics
# - POST /post/cleanup - Cleanup old queue entries
# - POST /geocode - Geocode address (no DB update)
# - POST /signup-location - Before User Created webhook (IP geolocation)
# - GET /signup-location - Signup location health sub-check
# - GET/POST /map/preferences - Map preferences per user/platform
# - POST /map/analytics - Track map interactions
# - GET /map/analytics - Detect map hotspots
# - GET/POST /map/quality - Adaptive quality settings
# - GET /map/preload - Predictive tile URL generation
# - GET /health - Health check
[functions.api-v1-geocoding]
verify_jwt = false

# =============================================================================
# UNIFIED ATTESTATION API v1
# =============================================================================
# Consolidates all device integrity verification:
# - iOS: App Attest, Assertion, DeviceCheck
# - Android: Play Integrity, SafetyNet
# Routes:
# - POST / - Auto-detect platform and verify attestation
# - POST /ios - iOS-specific attestation
# - POST /android - Android-specific attestation
# - GET /health - Health check
[functions.api-v1-attestation]
verify_jwt = false

# =============================================================================
# UNIFIED ANALYTICS API v1
# =============================================================================
# Syncs Supabase data to MotherDuck for analytics (replaces sync-analytics):
# - GET / - Sync status (last sync times, record counts)
# - GET /health - Health check
# - POST /sync - Trigger sync (mode=full|incremental)
# Cron: hourly incremental sync
[functions.api-v1-analytics]
verify_jwt = false

# System health monitoring & alerting (cron every 5 min)
# Checks error rates, latency, circuit breakers, login spikes, vault failures
[functions.api-v1-alerts]
verify_jwt = false

[functions.api-v1-analytics.schedule]
cron = "0 * * * *"
