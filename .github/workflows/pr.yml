name: PR Validation

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ── Shared CI checks ─────────────────────────────────────────────────
  ci:
    uses: ./.github/workflows/ci-checks.yml
    with:
      scan-dangerous-patterns: true

  # ── Type-check (PR-only) ─────────────────────────────────────────────
  typecheck:
    name: Type-check
    runs-on: [self-hosted, ubuntu-latest]
    needs: ci
    timeout-minutes: 5
    continue-on-error: true
    defaults:
      run:
        working-directory: supabase/functions
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: ./.github/actions/setup-deno

      - name: deno check
        id: check
        run: |
          set +e
          OUTPUT=$(deno check '**/*.ts' 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"

          ERROR_COUNT=$(echo "$OUTPUT" | grep -c "^error\[" || echo "0")
          echo "error-count=$ERROR_COUNT" >> "$GITHUB_OUTPUT"
          echo "exit-code=$EXIT_CODE" >> "$GITHUB_OUTPUT"

          BASELINE=324
          DELTA=$((ERROR_COUNT - BASELINE))
          echo "baseline=$BASELINE" >> "$GITHUB_OUTPUT"
          echo "delta=$DELTA" >> "$GITHUB_OUTPUT"

          {
            echo "## Type-check"
            echo ""
            if [ "$DELTA" -gt 0 ]; then
              echo "> **Warning**: TS errors increased by +$DELTA (now $ERROR_COUNT, baseline $BASELINE)"
            elif [ "$DELTA" -lt 0 ]; then
              echo "> TS errors decreased by $DELTA (now $ERROR_COUNT, baseline $BASELINE)"
            else
              echo "> TS errors unchanged: $ERROR_COUNT (baseline $BASELINE)"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

          exit $EXIT_CODE

  # ── Validate functions (PR-only, conditional) ────────────────────────
  validate-functions:
    name: Validate functions
    runs-on: [self-hosted, ubuntu-latest]
    needs: ci
    if: needs.ci.outputs.functions-changed == 'true' || needs.ci.outputs.shared-changed == 'true'
    timeout-minutes: 5
    defaults:
      run:
        working-directory: supabase/functions
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: ./.github/actions/setup-deno

      - name: Validate changed functions
        env:
          FUNCTIONS_LIST: ${{ needs.ci.outputs.functions-list }}
          SHARED: ${{ needs.ci.outputs.shared-changed }}
        run: |
          # If shared changed, validate all function dirs
          if [ "$SHARED" = "true" ]; then
            DIRS=$(find . -maxdepth 1 -type d \( -name 'api-v1-*' -o -name 'telegram-*' -o -name 'whatsapp-*' -o -name 'main' \) | sed 's|^\./||' | sort)
          else
            DIRS=$(echo "$FUNCTIONS_LIST" | jq -r '.[]' 2>/dev/null || echo "")
          fi

          if [ -z "$DIRS" ]; then
            echo "No function directories to validate"
            exit 0
          fi

          {
            echo "## Function Validation"
            echo ""
            echo "| Function | Type-check | Size | Deno.serve | No JSR | No cross-import |"
            echo "|----------|-----------|------|------------|--------|-----------------|"
          } >> "$GITHUB_STEP_SUMMARY"

          FAIL=0

          for DIR in $DIRS; do
            [ -d "$DIR" ] || continue
            [ -f "$DIR/index.ts" ] || continue

            TC_OK="pass"
            SIZE_OK="pass"
            SERVE_OK="pass"
            JSR_OK="pass"
            IMPORT_OK="pass"

            # 1. Type-check
            if ! deno check "$DIR/index.ts" 2>/dev/null; then
              TC_OK="warn"
            fi

            # 2. Bundle size via deno info
            SIZE_OUTPUT=$(deno info --json "$DIR/index.ts" 2>/dev/null || echo "{}")
            TOTAL_SIZE=$(echo "$SIZE_OUTPUT" | jq -r '.totalSize // 0' 2>/dev/null || echo "0")
            SIZE_MB=$((TOTAL_SIZE / 1048576))
            if [ "$SIZE_MB" -gt 5 ]; then
              SIZE_OK="FAIL (${SIZE_MB}MB)"
              FAIL=1
            else
              SIZE_OK="${SIZE_MB}MB"
            fi

            # 3. Deno.serve pattern
            if ! grep -q 'Deno\.serve(' "$DIR/index.ts"; then
              SERVE_OK="FAIL"
              FAIL=1
            fi

            # 4. No JSR imports
            if grep -rq 'jsr:@supabase/functions-js' "$DIR/"; then
              JSR_OK="FAIL"
              FAIL=1
            fi

            # 5. No cross-function imports (only _shared/ allowed)
            if grep -rE "from ['\"]\.\./(api-v1-|telegram-|whatsapp-|main/)" "$DIR/" 2>/dev/null; then
              IMPORT_OK="FAIL"
              FAIL=1
            fi

            echo "| $DIR | $TC_OK | $SIZE_OK | $SERVE_OK | $JSR_OK | $IMPORT_OK |" >> "$GITHUB_STEP_SUMMARY"
          done

          if [ "$FAIL" -ne 0 ]; then
            echo "::error::Function validation failed — see summary"
            exit 1
          fi

  # ── PR Summary (required status check) ──────────────────────────────
  pr-summary:
    name: PR Summary
    runs-on: [self-hosted, ubuntu-latest]
    needs: [ci, typecheck, validate-functions]
    if: always()
    timeout-minutes: 2
    steps:
      - name: Aggregate results
        env:
          LINT_RESULT: ${{ needs.ci.outputs.lint-result }}
          TYPECHECK_RESULT: ${{ needs.typecheck.result }}
          TEST_RESULT: ${{ needs.ci.outputs.test-result }}
          SECURITY_RESULT: ${{ needs.ci.outputs.security-result }}
          MIGRATIONS_RESULT: ${{ needs.ci.outputs.migrations-result }}
          FUNCTIONS_RESULT: ${{ needs.validate-functions.result }}
        run: |
          {
            echo "## PR Validation Summary"
            echo ""
            echo "| Job | Status |"
            echo "|-----|--------|"
            echo "| Lint | ${LINT_RESULT} |"
            echo "| Type-check | ${TYPECHECK_RESULT} |"
            echo "| Test | ${TEST_RESULT} |"
            echo "| Security | ${SECURITY_RESULT} |"
            echo "| Migrations | ${MIGRATIONS_RESULT:-skipped} |"
            echo "| Functions | ${FUNCTIONS_RESULT:-skipped} |"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Gate
        env:
          LINT_RESULT: ${{ needs.ci.outputs.lint-result }}
          TEST_RESULT: ${{ needs.ci.outputs.test-result }}
          SECURITY_RESULT: ${{ needs.ci.outputs.security-result }}
          MIGRATIONS_RESULT: ${{ needs.ci.outputs.migrations-result }}
          FUNCTIONS_RESULT: ${{ needs.validate-functions.result }}
        run: |
          for job in LINT TEST SECURITY MIGRATIONS FUNCTIONS; do
            eval "RESULT=\$${job}_RESULT"
            if [ "$RESULT" = "failure" ]; then
              echo "::error::${job,,} failed"
              exit 1
            fi
          done
          echo "All checks passed"
