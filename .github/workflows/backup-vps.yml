name: Backup VPS State

on:
  schedule:
    # Twice daily: 03:00 and 15:00 UTC
    - cron: "0 3,15 * * *"
  workflow_dispatch:
    inputs:
      full-backup:
        description: Include Docker volumes (larger, slower)
        type: boolean
        default: false

permissions:
  contents: read

concurrency:
  group: backup-vps
  cancel-in-progress: false

jobs:
  backup:
    name: Backup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_DEPLOY_CHAT_ID: ${{ secrets.TELEGRAM_DEPLOY_CHAT_ID }}

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Backup via SSH
        id: backup
        uses: appleboy/ssh-action@0ff4204d59e8e51228ff73bce53f80d53301dee2 # v1
        env:
          FULL_BACKUP: ${{ inputs.full-backup }}
        with:
          host: vps.foodshare.club
          username: organic
          key: ${{ secrets.VPS_SSH_KEY }}
          command_timeout: 8m
          envs: FULL_BACKUP
          script: |
            set -eo pipefail
            cd /home/organic/dev/foodshare-backend
            chmod +x scripts/deploy.sh

            TIMESTAMP=$(date -u +%Y-%m-%dT%H%M%SZ)
            echo "=== VPS Backup: $TIMESTAMP ==="

            # 0. Health check — verify services are running
            echo "--- Health check ---"
            UNHEALTHY=$(docker compose ps --format '{{.Name}} {{.Status}}' | grep -iv 'healthy\|running' || true)
            if [ -n "$UNHEALTHY" ]; then
              echo "WARNING: Unhealthy services detected:"
              echo "$UNHEALTHY"
            else
              echo "All services healthy"
            fi

            # 1. Core backup (DB, secrets, git state, rotation)
            ./scripts/deploy.sh backup --daily

            # 2. Full backup (Docker volumes, if requested)
            if [ "$FULL_BACKUP" = "true" ]; then
              echo "--- Docker volumes backup ---"
              BACKUP_DIR="/home/organic/backups"
              DATE=$(date -u +%Y-%m-%d)
              VOLUMES_FILE="$BACKUP_DIR/daily/volumes-$DATE.tar.gz"
              tar czf "$VOLUMES_FILE" \
                --exclude='volumes/db/data' \
                --exclude='volumes/storage' \
                volumes/ 2>/dev/null || true
              echo "Volumes: $(du -h "$VOLUMES_FILE" | cut -f1)"
            fi

            echo "=== Backup complete ==="

      - name: Backup summary
        if: always()
        env:
          BACKUP_OUTCOME: ${{ steps.backup.outcome }}
          FULL_BACKUP: ${{ inputs.full-backup || 'false' }}
        run: |
          {
            echo "## VPS Backup"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| **Status** | ${BACKUP_OUTCOME} |"
            echo "| **Time** | $(date -u +%Y-%m-%dT%H:%M:%SZ) |"
            echo "| **Full backup** | ${FULL_BACKUP} |"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Telegram — backup succeeded
        if: success() && env.TELEGRAM_BOT_TOKEN != ''
        uses: ./.github/actions/telegram-notify
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_DEPLOY_CHAT_ID }}
          message: "✅ *Backup OK* — VPS state backed up successfully"
          silent: "true"

      - name: Telegram — backup failed
        if: failure() && env.TELEGRAM_BOT_TOKEN != ''
        uses: ./.github/actions/telegram-notify
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_DEPLOY_CHAT_ID }}
          message: |
            ❌ *VPS backup failed*
            Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
