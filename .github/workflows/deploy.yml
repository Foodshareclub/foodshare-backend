name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force-restart:
        description: Ignore change detection, full restart
        type: boolean
        default: false
      skip-backup:
        description: Skip pre-deploy backup (faster, less safe)
        type: boolean
        default: false
      dry-run:
        description: Validate only, do not deploy
        type: boolean
        default: false

permissions:
  contents: read

concurrency:
  group: deploy
  cancel-in-progress: true

jobs:
  # ── Shared CI checks ─────────────────────────────────────────────────
  ci:
    uses: ./.github/workflows/ci-checks.yml

  # ── Deploy gate ──────────────────────────────────────────────────────
  deploy-gate:
    name: Deploy gate
    runs-on: ubuntu-latest
    needs: ci
    if: always() && !cancelled()
    timeout-minutes: 1
    steps:
      - name: Go / no-go
        env:
          LINT_RESULT: ${{ needs.ci.outputs.lint-result }}
          TEST_RESULT: ${{ needs.ci.outputs.test-result }}
          SECURITY_RESULT: ${{ needs.ci.outputs.security-result }}
          MIGRATIONS_RESULT: ${{ needs.ci.outputs.migrations-result }}
        run: |
          for job in LINT TEST SECURITY MIGRATIONS; do
            eval "RESULT=\$${job}_RESULT"
            if [ "$RESULT" = "failure" ]; then
              echo "::error::${job,,} failed — deploy blocked"
              exit 1
            fi
          done
          echo "All gates passed"

  # ── Deploy ───────────────────────────────────────────────────────────
  deploy:
    name: Deploy
    runs-on: self-hosted
    needs: [ci, deploy-gate]
    if: |
      !cancelled() &&
      needs.deploy-gate.result == 'success' &&
      needs.ci.result == 'success' &&
      inputs.dry-run != true &&
      (github.event_name == 'workflow_dispatch' || needs.ci.outputs.any-deployable == 'true')
    timeout-minutes: 10
    environment: production
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_DEPLOY_CHAT_ID: ${{ secrets.TELEGRAM_DEPLOY_CHAT_ID }}

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 1

      - name: Build change summary
        id: summary
        env:
          FN_CHANGED: ${{ needs.ci.outputs.functions-changed }}
          SHARED_CHANGED: ${{ needs.ci.outputs.shared-changed }}
          MIG_CHANGED: ${{ needs.ci.outputs.migrations-changed }}
          INFRA_CHANGED: ${{ needs.ci.outputs.infrastructure-changed }}
          CFG_CHANGED: ${{ needs.ci.outputs.config-changed }}
        run: |
          PARTS=""
          for pair in "FN_CHANGED:functions" "SHARED_CHANGED:shared" "MIG_CHANGED:migrations" \
                      "INFRA_CHANGED:infra" "CFG_CHANGED:config"; do
            KEY="${pair%%:*}"; LABEL="${pair##*:}"
            eval "VAL=\$$KEY"
            [ "$VAL" = "true" ] && PARTS="$PARTS $LABEL"
          done
          PARTS=$(echo "$PARTS" | xargs | tr ' ' ', ')
          echo "changes=${PARTS:-none}" >> "$GITHUB_OUTPUT"

      - name: Telegram — deploy started
        uses: ./.github/actions/telegram-notify
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_DEPLOY_CHAT_ID }}
          message: |
            ⏳ *Deploying foodshare-backend*
            Commit: `${{ github.sha }}` by ${{ github.actor }}
            Changes: ${{ steps.summary.outputs.changes }}

      - name: Deploy via SSH
        id: deploy
        uses: appleboy/ssh-action@0ff4204d59e8e51228ff73bce53f80d53301dee2 # v1
        env:
          FORCE_RESTART: ${{ inputs.force-restart }}
          SKIP_BACKUP: ${{ inputs.skip-backup }}
          FUNCTIONS_CHANGED: ${{ needs.ci.outputs.functions-changed }}
          SHARED_CHANGED: ${{ needs.ci.outputs.shared-changed }}
          MIGRATIONS_CHANGED: ${{ needs.ci.outputs.migrations-changed }}
          INFRASTRUCTURE_CHANGED: ${{ needs.ci.outputs.infrastructure-changed }}
          CONFIG_CHANGED: ${{ needs.ci.outputs.config-changed }}
        with:
          host: vps.foodshare.club
          username: organic
          key: ${{ secrets.VPS_SSH_KEY }}
          command_timeout: 8m
          envs: FORCE_RESTART,SKIP_BACKUP,FUNCTIONS_CHANGED,SHARED_CHANGED,MIGRATIONS_CHANGED,INFRASTRUCTURE_CHANGED,CONFIG_CHANGED
          script: |
            set -eo pipefail
            cd /home/organic/dev/foodshare-backend

            # ── Stage 0: Pull code first (ensures deploy script exists) ──
            echo "=== Stage: pull ==="
            PREV_HEAD=$(git rev-parse HEAD)
            git pull --ff-only
            NEW_HEAD=$(git rev-parse HEAD)
            chmod +x scripts/deploy.sh

            # ── Stage 1: Backup ──
            if [ "$SKIP_BACKUP" != "true" ]; then
              echo "=== Stage: backup ==="
              ./scripts/deploy.sh backup
            else
              echo "=== Skipping backup (skip-backup=true) ==="
            fi

            # ── Stage 2: Record pull state ──
            echo "=== Recording pull state ==="
            # NOTE: State is written inline (not via deploy.sh pull) because
            # git pull at Stage 0 must run BEFORE deploy.sh exists on disk.
            # Calling deploy.sh pull after would no-op and miss PREV_HEAD.
            echo '{}' > /tmp/deploy-state.json
            jq -n --arg started "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                  --arg stage "pull" \
                  --arg prev "$PREV_HEAD" \
                  --arg new "$NEW_HEAD" \
                  --arg changed "$(git diff --name-only "$PREV_HEAD" "$NEW_HEAD" | tr '\n' ',')" \
                  '{started_at: $started, stage: $stage, prev_head: $prev, new_head: $new, changed_files: $changed}' \
              > /tmp/deploy-state.json

            # ── Stage 3: Migrate ──
            if [ "$MIGRATIONS_CHANGED" = "true" ]; then
              echo "=== Stage: migrate ==="
              ./scripts/deploy.sh migrate
            else
              echo "=== Skipping migrations (no changes) ==="
            fi

            # ── Stage 4: Restart ──
            echo "=== Stage: restart ==="
            if [ "$FORCE_RESTART" = "true" ] || [ "$INFRASTRUCTURE_CHANGED" = "true" ]; then
              ./scripts/deploy.sh restart full
            elif [ "$FUNCTIONS_CHANGED" = "true" ] || [ "$SHARED_CHANGED" = "true" ] || [ "$CONFIG_CHANGED" = "true" ]; then
              ./scripts/deploy.sh restart functions
            elif [ "$MIGRATIONS_CHANGED" = "true" ]; then
              ./scripts/deploy.sh restart rest
            else
              echo "No restart needed"
            fi

            # ── Stage 5: Smoke tests ──
            echo "=== Stage: smoke ==="
            ./scripts/deploy.sh smoke

            echo "=== Deploy complete ==="

      - name: Deploy summary
        if: always()
        env:
          CHANGE_SUMMARY: ${{ steps.summary.outputs.changes }}
          FORCE_RESTART: ${{ inputs.force-restart || 'false' }}
          SKIP_BACKUP: ${{ inputs.skip-backup || 'false' }}
          DEPLOY_OUTCOME: ${{ steps.deploy.outcome }}
        run: |
          SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
          COMMIT_MSG=$(git log -1 --pretty=%s)
          {
            echo "## Deploy: \`${SHORT_SHA}\`"
            echo ""
            echo "| Field | Value |"
            echo "|-------|-------|"
            echo "| **Commit** | \`${SHORT_SHA}\` — ${COMMIT_MSG} |"
            echo "| **Actor** | ${GITHUB_ACTOR} |"
            echo "| **Changes** | ${CHANGE_SUMMARY} |"
            echo "| **Force restart** | ${FORCE_RESTART} |"
            echo "| **Skip backup** | ${SKIP_BACKUP} |"
            echo "| **Status** | ${DEPLOY_OUTCOME} |"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Telegram — deploy succeeded
        if: success()
        uses: ./.github/actions/telegram-notify
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_DEPLOY_CHAT_ID }}
          message: |
            ✅ *Deploy succeeded* — `${{ github.sha }}`
            Changes: ${{ steps.summary.outputs.changes }}

      - name: Telegram — deploy failed
        if: failure()
        uses: ./.github/actions/telegram-notify
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_DEPLOY_CHAT_ID }}
          message: |
            ❌ *DEPLOY FAILED* — `${{ github.sha }}`
            Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # ── Post-deploy (dry-run summary) ────────────────────────────────────
  dry-run-summary:
    name: Dry-run summary
    runs-on: ubuntu-latest
    needs: [ci, deploy-gate]
    if: inputs.dry-run == true && needs.deploy-gate.result == 'success'
    timeout-minutes: 1
    steps:
      - name: Summary
        env:
          FN_CHANGED: ${{ needs.ci.outputs.functions-changed }}
          SHARED_CHANGED: ${{ needs.ci.outputs.shared-changed }}
          MIG_CHANGED: ${{ needs.ci.outputs.migrations-changed }}
          INFRA_CHANGED: ${{ needs.ci.outputs.infrastructure-changed }}
          CFG_CHANGED: ${{ needs.ci.outputs.config-changed }}
        run: |
          {
            echo "## Dry Run — Validation Passed"
            echo ""
            echo "All gates passed. Deploy would proceed with:"
            echo "- Functions changed: ${FN_CHANGED}"
            echo "- Shared changed: ${SHARED_CHANGED}"
            echo "- Migrations changed: ${MIG_CHANGED}"
            echo "- Infrastructure changed: ${INFRA_CHANGED}"
            echo "- Config changed: ${CFG_CHANGED}"
          } >> "$GITHUB_STEP_SUMMARY"
