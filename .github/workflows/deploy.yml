name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force-restart:
        description: Ignore change detection, full restart
        type: boolean
        default: false
      skip-backup:
        description: Skip pre-deploy backup (faster, less safe)
        type: boolean
        default: false
      dry-run:
        description: Validate only, do not deploy
        type: boolean
        default: false

permissions:
  contents: read

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  # ── Change detection ──────────────────────────────────────────────────
  detect-changes:
    name: Detect changes
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      functions-changed: ${{ steps.changes.outputs.functions-changed }}
      functions-list: ${{ steps.changes.outputs.functions-list }}
      shared-changed: ${{ steps.changes.outputs.shared-changed }}
      migrations-changed: ${{ steps.changes.outputs.migrations-changed }}
      migrations-list: ${{ steps.changes.outputs.migrations-list }}
      infrastructure-changed: ${{ steps.changes.outputs.infrastructure-changed }}
      config-changed: ${{ steps.changes.outputs.config-changed }}
      any-deployable: ${{ steps.changes.outputs.any-deployable }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - id: changes
        uses: ./.github/actions/detect-changes

  # ── Lint ──────────────────────────────────────────────────────────────
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: detect-changes
    timeout-minutes: 3
    defaults:
      run:
        working-directory: supabase/functions
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: ./.github/actions/setup-deno

      - name: deno lint
        run: deno lint

      - name: deno fmt --check
        run: deno fmt --check

      - name: Check for problematic JSR imports
        run: |
          if grep -r "jsr:@supabase/functions-js" .; then
            echo "::error::Problematic JSR import detected!"
            exit 1
          fi

  # ── Test ─────────────────────────────────────────────────────────────
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: detect-changes
    timeout-minutes: 5
    defaults:
      run:
        working-directory: supabase/functions
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: ./.github/actions/setup-deno

      - name: deno test
        run: deno test --allow-all

  # ── Security ─────────────────────────────────────────────────────────
  security:
    name: Security scan
    runs-on: ubuntu-latest
    needs: detect-changes
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Scan for leaked secrets
        uses: trufflesecurity/trufflehog@7635b24fd512a2e817dd3e9dd661caaf035a079d # v3.93.1
        with:
          extra_args: --only-verified --results=verified

  # ── Validate migrations (conditional) ────────────────────────────────
  validate-migrations:
    name: Validate migrations
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.migrations-changed == 'true'
    timeout-minutes: 5

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: supabase_admin
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U supabase_admin"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq postgresql-client

      - name: Create schema_migrations table
        run: |
          psql -h localhost -U supabase_admin -d postgres -c "
            CREATE SCHEMA IF NOT EXISTS supabase_migrations;
            CREATE TABLE IF NOT EXISTS supabase_migrations.schema_migrations (
              version text PRIMARY KEY,
              statements text,
              name text
            );
          "
        env:
          PGPASSWORD: postgres

      - name: Apply baseline (best-effort)
        run: |
          psql -h localhost -U supabase_admin -d postgres \
            -f supabase/migrations/20260128195318_baseline.sql \
            2>&1 || true
        env:
          PGPASSWORD: postgres

      - name: Apply incremental migrations (strict)
        run: |
          FAILED=0
          for f in supabase/migrations/*.sql; do
            [ -f "$f" ] || continue
            BASENAME=$(basename "$f")

            if [ "$BASENAME" = "20260128195318_baseline.sql" ]; then
              continue
            fi

            if grep -qE '(cron\.(schedule|unschedule)|net\.http_(post|get))' "$f"; then
              echo "--- Skipping: $BASENAME (requires pg_cron/pg_net) ---"
              continue
            fi

            if grep -qE '(ALTER TABLE|CREATE INDEX|COMMENT ON|INSERT INTO|FROM)\s+(public\.)?(posts|profiles|community_fridges|blocked_users)|extensions\.(st_|geometry)|auth\.(uid|jwt|users)' "$f"; then
              echo "--- Skipping: $BASENAME (depends on baseline tables/extensions) ---"
              continue
            fi

            VERSION=$(echo "$BASENAME" | grep -oE '^[0-9]+')
            echo "--- Applying: $BASENAME ---"

            if ! psql -h localhost -U supabase_admin -d postgres \
              -v ON_ERROR_STOP=1 -f "$f"; then
              echo "::error::Migration failed: $BASENAME"
              FAILED=1
              break
            fi

            psql -h localhost -U supabase_admin -d postgres -c \
              "INSERT INTO supabase_migrations.schema_migrations (version) VALUES ('$VERSION') ON CONFLICT DO NOTHING;"
          done

          if [ "$FAILED" -ne 0 ]; then
            exit 1
          fi
        env:
          PGPASSWORD: postgres

  # ── Deploy gate ──────────────────────────────────────────────────────
  deploy-gate:
    name: Deploy gate
    runs-on: ubuntu-latest
    needs: [detect-changes, lint, test, security, validate-migrations]
    if: always() && !cancelled()
    timeout-minutes: 1
    steps:
      - name: Go / no-go
        env:
          LINT_RESULT: ${{ needs.lint.result }}
          TEST_RESULT: ${{ needs.test.result }}
          SECURITY_RESULT: ${{ needs.security.result }}
          MIGRATIONS_RESULT: ${{ needs.validate-migrations.result }}
        run: |
          if [ "$LINT_RESULT" = "failure" ]; then
            echo "::error::Lint failed — deploy blocked"
            exit 1
          fi
          if [ "$TEST_RESULT" = "failure" ]; then
            echo "::error::Tests failed — deploy blocked"
            exit 1
          fi
          if [ "$SECURITY_RESULT" = "failure" ]; then
            echo "::error::Security scan failed — deploy blocked"
            exit 1
          fi
          if [ "$MIGRATIONS_RESULT" = "failure" ]; then
            echo "::error::Migration validation failed — deploy blocked"
            exit 1
          fi
          echo "All gates passed"

  # ── Deploy ───────────────────────────────────────────────────────────
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-gate]
    if: |
      !cancelled() &&
      needs.deploy-gate.result == 'success' &&
      needs.detect-changes.result == 'success' &&
      inputs.dry-run != true
    timeout-minutes: 10
    environment: production
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_DEPLOY_CHAT_ID: ${{ secrets.TELEGRAM_DEPLOY_CHAT_ID }}

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 1

      - name: Build change summary
        id: summary
        env:
          FN_CHANGED: ${{ needs.detect-changes.outputs.functions-changed }}
          SHARED_CHANGED: ${{ needs.detect-changes.outputs.shared-changed }}
          MIG_CHANGED: ${{ needs.detect-changes.outputs.migrations-changed }}
          INFRA_CHANGED: ${{ needs.detect-changes.outputs.infrastructure-changed }}
          CFG_CHANGED: ${{ needs.detect-changes.outputs.config-changed }}
        run: |
          PARTS=""
          if [ "$FN_CHANGED" = "true" ]; then
            PARTS="$PARTS functions"
          fi
          if [ "$SHARED_CHANGED" = "true" ]; then
            PARTS="$PARTS shared"
          fi
          if [ "$MIG_CHANGED" = "true" ]; then
            PARTS="$PARTS migrations"
          fi
          if [ "$INFRA_CHANGED" = "true" ]; then
            PARTS="$PARTS infra"
          fi
          if [ "$CFG_CHANGED" = "true" ]; then
            PARTS="$PARTS config"
          fi
          PARTS=$(echo "$PARTS" | xargs | tr ' ' ', ')
          echo "changes=${PARTS:-none}" >> "$GITHUB_OUTPUT"

      - name: Telegram — deploy started
        uses: ./.github/actions/telegram-notify
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_DEPLOY_CHAT_ID }}
          message: |
            ⏳ *Deploying foodshare-backend*
            Commit: `${{ github.sha }}` by ${{ github.actor }}
            Changes: ${{ steps.summary.outputs.changes }}

      - name: Deploy via SSH
        id: deploy
        uses: appleboy/ssh-action@0ff4204d59e8e51228ff73bce53f80d53301dee2 # v1
        env:
          FORCE_RESTART: ${{ inputs.force-restart }}
          SKIP_BACKUP: ${{ inputs.skip-backup }}
          FUNCTIONS_CHANGED: ${{ needs.detect-changes.outputs.functions-changed }}
          SHARED_CHANGED: ${{ needs.detect-changes.outputs.shared-changed }}
          MIGRATIONS_CHANGED: ${{ needs.detect-changes.outputs.migrations-changed }}
          INFRASTRUCTURE_CHANGED: ${{ needs.detect-changes.outputs.infrastructure-changed }}
          CONFIG_CHANGED: ${{ needs.detect-changes.outputs.config-changed }}
        with:
          host: vps.foodshare.club
          username: organic
          key: ${{ secrets.VPS_SSH_KEY }}
          command_timeout: 8m
          envs: FORCE_RESTART,SKIP_BACKUP,FUNCTIONS_CHANGED,SHARED_CHANGED,MIGRATIONS_CHANGED,INFRASTRUCTURE_CHANGED,CONFIG_CHANGED
          script: |
            set -eo pipefail
            cd /home/organic/dev/foodshare-backend

            # Make deploy script available and executable
            chmod +x scripts/deploy.sh 2>/dev/null || true

            # ── Stage 1: Backup ──
            if [ "$SKIP_BACKUP" != "true" ]; then
              echo "=== Stage: backup ==="
              ./scripts/deploy.sh backup
            else
              echo "=== Skipping backup (skip-backup=true) ==="
            fi

            # ── Stage 2: Pull ──
            echo "=== Stage: pull ==="
            ./scripts/deploy.sh pull

            # ── Stage 3: Migrate ──
            if [ "$MIGRATIONS_CHANGED" = "true" ]; then
              echo "=== Stage: migrate ==="
              ./scripts/deploy.sh migrate
            else
              echo "=== Skipping migrations (no changes) ==="
            fi

            # ── Stage 4: Restart ──
            echo "=== Stage: restart ==="
            if [ "$FORCE_RESTART" = "true" ] || [ "$INFRASTRUCTURE_CHANGED" = "true" ]; then
              ./scripts/deploy.sh restart full
            elif [ "$FUNCTIONS_CHANGED" = "true" ] || [ "$SHARED_CHANGED" = "true" ] || [ "$CONFIG_CHANGED" = "true" ]; then
              ./scripts/deploy.sh restart functions
            elif [ "$MIGRATIONS_CHANGED" = "true" ]; then
              ./scripts/deploy.sh restart rest
            else
              echo "No restart needed"
            fi

            # ── Stage 5: Smoke tests ──
            echo "=== Stage: smoke ==="
            ./scripts/deploy.sh smoke

            echo "=== Deploy complete ==="

      - name: Deploy summary
        if: always()
        env:
          CHANGE_SUMMARY: ${{ steps.summary.outputs.changes }}
          FORCE_RESTART: ${{ inputs.force-restart || 'false' }}
          SKIP_BACKUP: ${{ inputs.skip-backup || 'false' }}
          DEPLOY_OUTCOME: ${{ steps.deploy.outcome }}
        run: |
          SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
          COMMIT_MSG=$(git log -1 --pretty=%s)
          {
            echo "## Deploy: \`${SHORT_SHA}\`"
            echo ""
            echo "| Field | Value |"
            echo "|-------|-------|"
            echo "| **Commit** | \`${SHORT_SHA}\` — ${COMMIT_MSG} |"
            echo "| **Actor** | ${GITHUB_ACTOR} |"
            echo "| **Changes** | ${CHANGE_SUMMARY} |"
            echo "| **Force restart** | ${FORCE_RESTART} |"
            echo "| **Skip backup** | ${SKIP_BACKUP} |"
            echo "| **Status** | ${DEPLOY_OUTCOME} |"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Telegram — deploy succeeded
        if: success()
        uses: ./.github/actions/telegram-notify
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_DEPLOY_CHAT_ID }}
          message: |
            ✅ *Deploy succeeded* — `${{ github.sha }}`
            Changes: ${{ steps.summary.outputs.changes }}

      - name: Telegram — deploy failed
        if: failure()
        uses: ./.github/actions/telegram-notify
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_DEPLOY_CHAT_ID }}
          message: |
            ❌ *DEPLOY FAILED* — `${{ github.sha }}`
            Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # ── Post-deploy (dry-run summary) ────────────────────────────────────
  dry-run-summary:
    name: Dry-run summary
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-gate]
    if: inputs.dry-run == true && needs.deploy-gate.result == 'success'
    timeout-minutes: 1
    steps:
      - name: Summary
        env:
          FN_CHANGED: ${{ needs.detect-changes.outputs.functions-changed }}
          SHARED_CHANGED: ${{ needs.detect-changes.outputs.shared-changed }}
          MIG_CHANGED: ${{ needs.detect-changes.outputs.migrations-changed }}
          INFRA_CHANGED: ${{ needs.detect-changes.outputs.infrastructure-changed }}
          CFG_CHANGED: ${{ needs.detect-changes.outputs.config-changed }}
        run: |
          {
            echo "## Dry Run — Validation Passed"
            echo ""
            echo "All gates passed. Deploy would proceed with:"
            echo "- Functions changed: ${FN_CHANGED}"
            echo "- Shared changed: ${SHARED_CHANGED}"
            echo "- Migrations changed: ${MIG_CHANGED}"
            echo "- Infrastructure changed: ${INFRA_CHANGED}"
            echo "- Config changed: ${CFG_CHANGED}"
          } >> "$GITHUB_STEP_SUMMARY"
